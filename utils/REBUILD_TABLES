#!/bin/bash
#
# REBUILD_TABLES - Database Table Creation and Restoration Script
# ==============================================================
#
# DESCRIPTION:
#   This script rebuilds the database tables for the VHS application.
#   It can either create fresh tables with default data or restore 
#   from an existing backup using the IMPEX utility.
#
# USAGE:
#   utils/REBUILD_TABLES [--restore]
#
# OPTIONS:
#   --restore   Restore database from the most recent backup instead of
#               creating fresh tables (uses IMPEX --import)
#
# DEPENDENCIES:
#   - Docker with a running PostgreSQL container
#   - Backend server must be running at localhost:4000
#   - IMPEX utility script (for restore functionality)
#   - SETADMIN utility script
#
# NOTES:
#   - Without the --restore flag, this script will drop and recreate the
#     database, run all SQL setup scripts, and create an admin user
#   - With the --restore flag, this script will import the latest database
#     backup using IMPEX
#
# EXAMPLES:
#   utils/REBUILD_TABLES           # Create fresh database tables
#   utils/REBUILD_TABLES --restore # Restore from latest backup
#
# AUTHOR:
#   VHS Development Team
#



# Parse command line arguments
RESTORE=false

# Check for the --restore flag
for arg in "$@"; do
  if [ "$arg" = "--restore" ]; then
    RESTORE=true
  fi
done

rebuild_database() {
    local db_container=$1
    PW=`cat ${ROOT_DIR}/.adminpw`

    echo "----------------------------------------------------"
    echo "DB Container: ${db_container}"
    echo "PW: ${PW}"
    echo "----------------------------------------------------"
    
    # wipe the database as well
    echo "Dropping and recreating database..."
    ${ROOT_DIR}/backend/db/wipe.sh
    ${ROOT_DIR}/backend/db/000_create_admin_user.sh
    ${ROOT_DIR}/backend/db/010_create_users_tables.sh
    ${ROOT_DIR}/backend/db/030_create_course_tables_v1.sh
    ${ROOT_DIR}/backend/db/040_create_course_tables_v2.sh
    ${ROOT_DIR}/backend/db/120_create_quotes_table.sh 
    ${ROOT_DIR}/backend/db/200_create_player_card_tables.sh

    # Verify database structure
    /usr/bin/docker exec -it $db_container psql -U admin -d vhsdb -c "\dt"
    /usr/bin/docker exec -it $db_container psql -U admin -d vhsdb -c "\q"

    # Show users table
    /usr/bin/docker exec -it $db_container psql -U admin -d vhsdb -c "SELECT * FROM users;"
}

# Check if restore flag is set
if [ "$RESTORE" = true ]; then
    echo "Restoring database from backup using IMPEX..."
    bash utils/IMPEX --import
    echo "Database restore complete!"
    exit 0
else
    # Only run the normal rebuild process if not restoring
    rebuild_database $(docker ps --format "{{.Names}}" | grep db)
fi
