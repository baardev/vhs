#!/bin/bash
#
# REFRESH_TOKEN - Authentication Token Test/Refresh
# ================================================
#
# DESCRIPTION:
#   Tests the current authentication token and forces a refresh if needed
#
# USAGE:
#   utils/REFRESH_TOKEN [username] [password]
#

echo "Testing authentication..."

# Check if we have stored credentials
if [ $# -eq 2 ]; then
  USERNAME="$1"
  PASSWORD="$2"
else
  # Default admin credentials
  USERNAME="adminuser"
  PASSWORD="adminuser"  # Adjust default password if needed
fi

echo "Logging in as $USERNAME..."

# Make login request
LOGIN_RESPONSE=$(curl -s -X POST http://localhost:4000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"'${USERNAME}'","password":"'${PASSWORD}'"}')

# Check if login was successful
if [[ $LOGIN_RESPONSE == *"token"* ]]; then
  echo "Login successful!"
  
  # Extract token from response
  TOKEN=$(echo $LOGIN_RESPONSE | grep -o '"token":"[^"]*' | sed 's/"token":"//')
  
  # Extract user data
  USER_DATA=$(echo $LOGIN_RESPONSE | grep -o '"user":{[^}]*}' | sed 's/"user"://')
  
  echo "Token received: ${TOKEN:0:20}..."
  echo "User data: $USER_DATA"
  
  # Test token with an admin API request
  echo "Testing token with admin API..."
  ADMIN_TEST=$(curl -s -X GET http://localhost:4000/api/admin/users?limit=1 \
    -H "Authorization: Bearer $TOKEN")
  
  if [[ $ADMIN_TEST == *"users"* ]]; then
    echo "Admin API access successful!"
  else
    echo "Admin API access failed. Response: $ADMIN_TEST"
  fi
  
  # Now save the token for the frontend to use
  echo "Creating token file for frontend..."
  echo "// This file was generated by REFRESH_TOKEN script" > frontend/public/debug-token.js
  echo "// Copy-paste these commands in browser console to update your token" >> frontend/public/debug-token.js
  echo "localStorage.setItem('token', '$TOKEN');" >> frontend/public/debug-token.js
  echo "localStorage.setItem('userData', '$USER_DATA');" >> frontend/public/debug-token.js
  echo "console.log('Token and user data updated!');" >> frontend/public/debug-token.js
  echo "window.dispatchEvent(new Event('authChange'));" >> frontend/public/debug-token.js
  
  echo "File created at frontend/public/debug-token.js"
  echo ""
  echo "To use this token in your browser:"
  echo "1. Open developer tools (F12)"
  echo "2. Go to Console tab"
  echo "3. Copy-paste this command:"
  echo ""
  echo "fetch('/debug-token.js').then(r=>r.text()).then(t=>eval(t))"
  echo ""
else
  echo "Login failed. Response: $LOGIN_RESPONSE"
fi 