#!/bin/bash

# Parse command line arguments
BUILDX=false
BAKE=false

for arg in "$@"
do
    case $arg in
        --buildx)
        BUILDX=true
        shift
        ;;
        --bake)
        BAKE=true
        shift
        ;;
    esac
done

# Set environment variables based on arguments
if [ "$BAKE" = true ]; then
    export COMPOSE_BAKE=true
    echo "Bake mode enabled"
else
    echo "Bake mode disabled"
fi

docker-compose down -v
#docker rmi vhs_backend vhs_frontend  # replace with your exact image names

# wipe everything
docker stop $(docker ps -q)
docker rm $(docker ps -a -q)
docker rmi $(docker images -q) -f

# Configure buildx if requested
docker buildx create --use
# docker-compose -f docker-compose.yml -f docker-compose.build.yml build
# docker-compose build

docker-compose up -d
docker-compose ps

sleep 15

DB_CONTAINER=$(docker ps --format "{{.Names}}" | grep db)

if [ -z "$DB_CONTAINER" ]; then
    echo "Database container not found"
    exit 1
fi

docker exec -it $DB_CONTAINER psql -U user -d vhsdb -c "\dt"
docker exec -it $DB_CONTAINER psql -U user -d vhsdb -c "\q"

docker exec -i $DB_CONTAINER psql -U user -d vhsdb < backend/sql/01_setup_database.sql
docker exec -i $DB_CONTAINER psql -U user -d vhsdb < backend/sql/02_create_quotes_table.sql
docker exec -i $DB_CONTAINER psql -U user -d vhsdb < backend/sql/03_course_tables.sql
docker exec -i $DB_CONTAINER psql -U user -d vhsdb < backend/sql/04_update_user_table.sql
docker exec -i $DB_CONTAINER psql -U user -d vhsdb < backend/sql/05_todo_table.sql
docker exec -i $DB_CONTAINER psql -U user -d vhsdb < backend/sql/06_create_default_users.sql
docker exec -it $DB_CONTAINER psql -U user -d vhsdb -c "\dt"
docker exec -it $DB_CONTAINER psql -U user -d vhsdb -c "\q"

docker exec -it $DB_CONTAINER psql -U user -d vhsdb -c "SELECT id, username, email, password FROM users;"